# 网络协议体系
## 应用层
* 通过应用进程间的交互和通信来完成特定的网络应用。应用层协议定义了进程间通信交互的规则。
* 单位：报文
* FTP， HTTP， DNS， Talnet， SMTP，SSH，DHCP
## 运输层
* 上层数据分段，负责两台主机间进程的数据传输服务
* 单位：段、报文
* 网关
## 网络层
* 将报文段或用户数据报封装成分组和包，选择合适的网间路由和交换节点，确保数据及时传送（不可靠、无连接）
* 单位：IP数据报、包
* 路由器
* IP协议，ICMP协议，ARP，RARP，RIP（路由信息协议，15跳，运行在udp上的应用层协议），OSPF，BGP
## 数据链路层
* 把IP数据报组装成帧，传送到相邻节点
* 单位：帧   以太网协议
* 网桥， 交换机（独占）
* ARQ（自动重传请求协议），CSMA/CD（停止等待协议），PPP(点对点协议)
## 物理层
* 实现两台计算机节点间比特流的透明传输
* 单位：比特
* 中继器（独占），集线器（共享）

# 以太网帧
## Ethernet II  Length/Type >= 1536
首部：6字节目的地址、6字节源地址、2字节帧类型（判断发给上层哪个协议，0x0800IP协议，0x0806ARP）
数据：46-1500字节，ARP只有28字节，要18个字节填充
尾部：4字节校验字段FCS（帧校验序列）
## IEEE802.3  Length/Type <= 1500
首部：6字节目的地址、6字节源地址、2字节长度、3字节的LLC逻辑链路控制（1字节目的服务访问点DSAP、1字节源服务访问点SSAP、Control)、5字节SNAP（3字节机构代码、2字节Type和EthernetII的一样）
数据：38-1500
尾部：4字节校验字段FCS
## 单播
一对一，基于TCP的协议都是单播。邮件、浏览网页
### 优点
* 服务器及时响应客户机的请求
* 针对不同客户请求发送不同数据，实现个性化服务
### 缺点
* 客户机流量大，服务器不堪重负
* 网络主干带宽有限
## 组播（多播）
一对多，消息在每条链路只需传递一次，链路分叉才要复制。网上视频会议（MAC地址最高字节最后一位是1，D类IP地址）
### 优点
* 需要相同数据流的客户端共享一条数据流，节省服务器负载
* 可以在Internet宽带网传输
### 缺点
* 没有纠错
## 广播
一对所有（MAC地址都为1）
### 优点
* 设备简单，维护简单，布网成本低
* 服务器负载极低
### 缺点
* 只能在局域网，防止广播风暴
* 无个性化服务

# 三次握手
* 第一次：客户端将标志位SYN置1，随机产生一个序列号seq=X，发送给服务端，客户端进入SYN_SENT状态
* 第二次：客户端将SYN和ACK置1，确认号ack=X+1，产生随机序列号Y，发给客户端，服务端进入SYN_RCVD状态
* 第三次：客户端检查ack是否为X+1，正确则将ACK置1，ack=Y+1，发给服务端。服务端收到后检查，成功则建立连接，都进入ESTABLISHED状态
# 两次握手可不可以
* 已失效的连接请求又传到服务端
* 无法保证客户端收到第二次握手的报文，序列号没有得到确认
# 四次挥手
* 客户端和服务器都可以发起断开连接请求
* 第一次：客户端发送FIN=M，进入FIN_WAIT_1状态
* 第二次：服务器收到FIN后，发送ACK，ack=M+1，服务端可能数据没传完，服务端进入CLOSE_WAIT状态，客户端进入FIN_WAIT_2状态
* 第三次：服务端数据发送完成，发送FIN=N，服务端进入LAST_ACK状态
* 第四次：客户端收到FIN报文，再次发送ACK，ack=N+1后进入TIME_WAIT状态，等待两个最大报文寿命后关闭连接，服务端可能没收到ack报文，会进行重传。
# TCP 应答机制和序列号
* 接收端收到数据后会发送确认应答，发送端没收到应答，可能数据丢失了
* 一定时间内没收到应答，发送端会进行重发，保证数据能够到达，实现可靠传输
* 没收到确认应答不一定是数据丢失，可能是确认应答丢失。发送端都会按机制进行重发
* 接收端反复收到重复数据是不行的，必须丢弃重复包，引入序列号
* 序列号给每个字节编号，接收端查询TCP首部的序列号和数据长度，把下一步应收到的序列号作为确认应答发回
* TCP可以识别接收端是否已接收数据，接收端是否要接受数据
# TCP 重发
## 超时重发
TCP会统计每次发送到收到确认应答的时间，计算出超时重发时间，重发后等待时间会指数增加，达到一定重发次数后会强制断开连接
## 快速重发
快重传：发送端连续收到3个重复确认后重新发送丢失报文段（即使没到超时重发时间）
# IP头部
IP头部至少20字节，最大60字节。4位版本号、4位头部长度（单位4字节）、16位总长度（单位1字节）、16位标志（数据报唯一标志，加一法赋值）、3位标志+13位分片偏移（单位8字节）、8位生存时间（路由跳跳数）、16位头部校验和（用CRC算法可检测头部是否损坏。只有头部）、32位源IP目的IP
* 无连接：每个数据报都是独立的，
* 不可靠：不维护后续数据报的状态信息，不保证IP数据报送达
# TCP头部
至少20字节，最大60字节。16位源端口目的端口、32位序号、32位确认号、4位头部长度（单位4字节）、6位保留、6位标志位（URG、PSH、ACK、SYN、FIN、RST）、16位窗口、16位校验和（发送端填充，接收端对报文段执行CRC算法检验是否损坏。整个TCP片段）、16位紧急指针

# IP分片
MTU（最大传输单元）是链路层网络对帧数据的限制（以太网是1500字节），IP数据报超过MTU就要分片，分片传输后到达目的IP后按照IP头部信息按序重组，只有第一片有传输层头部。分片和重组发生在网络层。要避免分片，丢失一片就要全部重传。
# TCP分段
MSS（最大报文段长度）是TCP能够传输的最大数据分段，大于MSS就要分段传输。TCP建立时双方协商MSS值（只出现在SYN报文，前两次握手）。MSS一般为MTU减去两个头部。  
MSS<=MTU， TCP分段后就不用分片，UDP会分片
# TCP的可靠性
* 校验位，保证数据传输过程不被破坏
* 序列号，不按顺序到达的数据可以重组
* 确认，重传机制，保证每个段都会到达
# ICMP协议（网络层协议）
1、检测网络通信，确认IP数据包能到达目标地址
2、通知发送途中IP包被丢弃原因
## ping
发送端发送回送请求报文，接收端发送会送应答报文，检测链路是否有问题，目标地址是否可达，通信延迟  
基于ICMP协议，无端口
## traceroute
发送多个探测报文，第一个TTL为1，到达第一个路由器后TTL为0，丢掉这个探测包，向源主机发送ICMP超时报文，这样就获得第一个路由器地址，以此类推，源主机就能获得到达目标地址每一跳路由的IP

# 滑动窗口


# NAT 网络地址转换
路由器有两个IP地址，WAN口IP和LAN口IP，子网要和外网通信，路由器将IP首部的IP地址替换成WAN口IP，逐渐替换，最终成为公网IP

# 路由
IP数据包到达路由器时，路由器查看目的IP，在路由表上将目的IP和每行的掩码计算比对，匹配则直接发往目的主机，若不匹配则发往下一个路由

# DNS （应用层53端口）
## 递归查询
客户端向dns服务器请求，服务器必须返回明确的结果，成功或失败
## 迭代查询
服务器另一台DNS服务器IP，循环直到找到结果
## 解析过程
* 浏览器输入www.baidu.com,操作系统先检查本地hosts文件有没有网址映射，有就直接返回
* hosts没有，就查本地dns解析器缓存，有就返回
* 找本地dns服务器，如果查询域名在本地配置区域资源中，返回解析结果，此结果有权威性
* 不由本地DNS服务器区域解析，但服务器缓存了网址映射关系，此解析结果没有权威性
* DNS服务器没设置转发模式，本地DNS服务器把请求转发刀根服务器，根服务器判断域名由谁管理，返回下一级域名服务器的IP，本地DNS服务器收到后访问这个IP，重复知道完成解析
* 转发模式，DNS服务器把请求转发至上一级域名服务器，服务器不能解析就再转发至上级
* 客户端到本地DNS服务器是递归查询，DNS服务器间的交互查询是迭代查询
# ARP
建立IP地址和MAC地址的映射关系
* 源主机先在ARP缓冲区寻找映射，若有则返回mac地址
* 没有就通过路由广播，联网的主机收到请求，传到网络层，对比IP地址，不匹配则丢弃这个包
* 匹配则把源主机的mac地址加入到ARP缓冲区中，回复ARP请求
* 源主机收到mac地址，加入到ARP缓冲区
* 如果不在一个子网内，要通过路由器多次转发
# DHCP动态主机配置协议（应用层，客户端68端口，服务器67端口）
## 发现Discover  客->服
客户端不知道自己IP，设成0.0.0.0，不知道目的IP，设成255.255.255.255,广播寻找  
其他主机收到这个包丢弃掉，DHCP服务器接收
## 提供Offer  服->客
客户端没有IP，DHCP服务器只能广播，报文包含分配IP和子网掩码，客户端通过transaction ID确认是否是自己的请求
## 请求Request  客->服
客户端可能收到多台DHCP服务器的offer，只接收第一个收到的IP地址，由于还没和DHCP服务器确认，不能使用给的IP  
广播发送，每台DHCP服务器检查，若不是自己IP则分配IP地址无效
## 确认ACK  服->客
若检查是，广播发送ACK报文，告知IP分配给客户端，并将IP和MAC地址绑定
## 地址重复检查  客
有可能IP被其他客户端配置了静态IP，刚好和申请到的相同，客户端先进行ARP请求，如果有回应说明IP被申请了，一段时间没回应就没人使用
## 续约Reqack
租约剩50%，客户端请求续约，服务器返回NAK则IP不可用了，客户端要从discover重新开始，以当前的ip；若收到ACK则续约成功（这个过程都是单播了）。租约到87.5%时，重复上述过程。租约到了还没续约成功则客户端要释放IP，重新申请

## 客户端和DHCP服务器不在一个局域网，需要一个中继器（要有一个静态地址，还有指定DHCP服务器地址）


